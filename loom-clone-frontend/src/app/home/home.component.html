<div class="home-container">
  <header class="header">
    <h1>Loom Clone</h1>
    <p class="subtitle">Record your screen, camera, and microphone</p>
  </header>

  <!-- Unsupported Browser Warning -->
  @if (!isSupported()) {
    <div class="warning-card" role="alert" aria-live="polite">
      <div class="warning-icon" aria-hidden="true">‚ö†Ô∏è</div>
      <div class="warning-content">
        <h2>Browser Not Supported</h2>
        <p>{{ supportMessage() }}</p>
        <p class="warning-details">
          This application requires the File System Access API, which is only available in
          Chromium-based browsers like Google Chrome, Microsoft Edge, or Opera.
        </p>
      </div>
    </div>
  } @else {
    <!-- Main Content - Folder Selection -->
    <main class="main-content">
      <!-- Loading State -->
      @if (isLoading()) {
        <div class="loading-card" role="status" aria-live="polite">
          <div class="spinner" aria-hidden="true"></div>
          <p>Loading folder information...</p>
        </div>
      }

      <!-- Error Message -->
      @if (errorMessage()) {
        <div class="error-message" role="alert" aria-live="assertive">
          <span class="error-icon" aria-hidden="true">‚ùå</span>
          {{ errorMessage() }}
        </div>
      }

      <!-- No Folder Selected -->
      @if (!hasFolder() && !isLoading()) {
        <div class="card">
          <div class="card-icon" aria-hidden="true">üìÅ</div>
          <h2>Select Recording Folder</h2>
          <p class="card-description">
            Choose a folder where your recordings will be saved. You'll only need to do this once.
          </p>
          <button
            type="button"
            class="btn btn-primary"
            (click)="onSelectFolder()"
            aria-label="Select a folder for saving recordings"
          >
            Select Folder
          </button>
        </div>
      }

      <!-- Folder Selected - Needs Permission -->
      @if (needsPermission()) {
        <div class="card card-warning">
          <div class="card-icon" aria-hidden="true">üîí</div>
          <h2>Permission Required</h2>
          <p class="card-description">Grant permission to save recordings to:</p>
          <p class="folder-name">{{ folderName() }}</p>
          <button
            type="button"
            class="btn btn-primary"
            (click)="onGrantPermission()"
            aria-label="Grant permission to access the selected folder"
          >
            Grant Permission
          </button>
          <button
            type="button"
            class="btn btn-secondary"
            (click)="onChangeFolder()"
            aria-label="Change to a different folder"
          >
            Change Folder
          </button>
        </div>
      }

      <!-- Ready to Record -->
      @if (isReady()) {
        <div class="card card-success">
          <div class="card-icon" aria-hidden="true">‚úÖ</div>
          <h2>Ready to Record</h2>
          <p class="card-description">Recordings will be saved to:</p>
          <p class="folder-name">{{ folderName() }}</p>
          <button
            type="button"
            class="btn btn-secondary"
            (click)="onChangeFolder()"
            aria-label="Change to a different folder"
          >
            Change Folder
          </button>
          <div class="info-message">
            <p><strong>Next steps:</strong> Select your recording devices below</p>
          </div>
        </div>

        <!-- Recording Devices Section -->
        <div class="devices-section">
          <h2 class="section-title">Recording Devices</h2>
          <p class="section-description">Select your camera and microphone for recording</p>

          <!-- Device Loading State -->
          @if (mediaDevicesEnumerating()) {
            <div class="loading-card" role="status" aria-live="polite">
              <div class="spinner" aria-hidden="true"></div>
              <p>Detecting available devices...</p>
            </div>
          }

          <!-- Device Error Message -->
          @if (mediaDeviceError()) {
            <div class="error-message" role="alert" aria-live="assertive">
              <span class="error-icon" aria-hidden="true">‚ùå</span>
              {{ mediaDeviceError() }}
            </div>
          }

          <!-- Device Selection Form -->
          @if (!mediaDevicesEnumerating()) {
            <div class="card">
              <div class="form-group">
                <label class="form-label" for="screen-sharing-toggle"> üñ•Ô∏è Screen sharing </label>
                <label class="toggle-label" for="screen-sharing-toggle">
                  <input
                    id="screen-sharing-toggle"
                    type="checkbox"
                    class="toggle-input"
                    [checked]="screenSharingEnabled()"
                    (change)="onToggleScreenSharing($event)"
                    aria-label="Enable or disable screen sharing mode"
                  />
                  <span>Record screen or window</span>
                </label>
                @if (screenSharingEnabled()) {
                  <p class="field-note">
                    Starting recording will open the browser picker so you can choose a screen or
                    window.
                  </p>
                }
              </div>

              <div class="form-group">
                <label for="camera-select" class="form-label"> üìπ Camera </label>
                <select
                  id="camera-select"
                  class="form-select"
                  (change)="onSelectCamera($event)"
                  [value]="selectedCameraKey() || ''"
                >
                  <option value="" disabled>
                    {{
                      availableCameras().length === 0 ? 'No cameras detected' : 'Choose a camera...'
                    }}
                  </option>
                  @for (camera of availableCameras(); track camera.selectionKey) {
                    <option [value]="camera.selectionKey">
                      {{ camera.label }}
                    </option>
                  }
                </select>
                <label class="toggle-label" for="camera-toggle">
                  <input
                    id="camera-toggle"
                    type="checkbox"
                    class="toggle-input"
                    [checked]="cameraEnabled()"
                    (change)="onToggleCamera($event)"
                    aria-label="Enable or disable camera"
                  />
                  <span>Camera enabled</span>
                </label>
              </div>

              <div class="form-group">
                <label for="mic-select" class="form-label"> üé§ Microphone </label>
                <select
                  id="mic-select"
                  class="form-select"
                  (change)="onSelectMicrophone($event)"
                  [value]="selectedMicrophoneKey() || ''"
                >
                  <option value="" disabled>
                    {{
                      availableMicrophones().length === 0
                        ? 'No microphones detected'
                        : 'Choose a microphone...'
                    }}
                  </option>
                  @for (mic of availableMicrophones(); track mic.selectionKey) {
                    <option [value]="mic.selectionKey">
                      {{ mic.label }}
                    </option>
                  }
                </select>
                <label class="toggle-label" for="microphone-toggle">
                  <input
                    id="microphone-toggle"
                    type="checkbox"
                    class="toggle-input"
                    [checked]="microphoneEnabled()"
                    (change)="onToggleMicrophone($event)"
                    aria-label="Enable or disable microphone"
                  />
                  <span>Microphone enabled</span>
                </label>
              </div>

              <!-- Permission Request -->
              @if (needsMediaPermission()) {
                <button
                  type="button"
                  class="btn btn-primary devices-btn"
                  (click)="onGrantMediaPermission()"
                >
                  Grant Camera & Microphone Access
                </button>
              }

              <!-- Ready State -->
              @if (mediaDeviceReady()) {
                <div class="success-message">
                  <span class="success-icon" aria-hidden="true">‚úì</span>
                  @if (hasEnabledInput()) {
                    Devices configured and ready!
                  } @else {
                    No camera or microphone selected for this recording.
                  }
                </div>
              }

              @if (recordingError()) {
                <div class="error-message recording-error" role="alert" aria-live="assertive">
                  <span class="error-icon" aria-hidden="true">‚ùå</span>
                  {{ recordingError() }}
                </div>
              }

              @if (recordingStatusMessage()) {
                <div class="info-message" role="status" aria-live="polite">
                  <p>{{ recordingStatusMessage() }}</p>
                </div>
              }

              <div class="recording-controls">
                <p class="recording-status" aria-live="polite">
                  Recording status: <strong>{{ recordingStatus() }}</strong>
                </p>

                @if (screenSharingEnabled() && cameraEnabled()) {
                  <p class="field-note">
                    Camera is ignored while screen sharing is enabled in this MVP build.
                  </p>
                }

                @if (!isRecording()) {
                  <button
                    type="button"
                    class="btn btn-primary devices-btn"
                    (click)="onStartRecording()"
                    [disabled]="!canStartRecording()"
                    aria-label="Start recording"
                  >
                    Start Recording
                  </button>
                } @else {
                  <button
                    type="button"
                    class="btn btn-secondary devices-btn"
                    (click)="onStopRecording()"
                    aria-label="Stop recording"
                  >
                    Stop Recording
                  </button>
                }
              </div>
            </div>
          }
        </div>

        <div class="recordings-section">
          <h2 class="section-title">Previous Recordings</h2>
          <p class="section-description">Click a recording below to play it back</p>

          @if (recordingsLoading()) {
            <div class="loading-card" role="status" aria-live="polite">
              <div class="spinner" aria-hidden="true"></div>
              <p>Loading recordings...</p>
            </div>
          }

          @if (recordingsError()) {
            <div class="error-message" role="alert" aria-live="assertive">
              <span class="error-icon" aria-hidden="true">‚ùå</span>
              {{ recordingsError() }}
            </div>
          }

          @if (!recordingsLoading() && !recordingsError()) {
            <div class="card recordings-card">
              @if (hasRecordings()) {
                <ul class="recordings-list" aria-label="Saved recordings">
                  @for (recording of recordings(); track recording.name) {
                    <li>
                      <button
                        type="button"
                        class="recording-item"
                        [class.recording-item-active]="selectedRecording()?.name === recording.name"
                        (click)="onPlayRecording(recording)"
                        [attr.aria-label]="'Play recording ' + recording.name"
                      >
                        <span class="recording-name">{{ recording.name }}</span>
                        <span class="recording-meta">
                          {{ formatTimestamp(recording.lastModified) }} ¬∑
                          {{ formatFileSize(recording.size) }}
                        </span>
                      </button>
                    </li>
                  }
                </ul>
              } @else {
                <p class="card-description recordings-empty">
                  No recordings found in this folder yet.
                </p>
              }
            </div>
          }

          @if (playbackError()) {
            <div class="error-message" role="alert" aria-live="assertive">
              <span class="error-icon" aria-hidden="true">‚ùå</span>
              {{ playbackError() }}
            </div>
          }

          @if (playbackLoading()) {
            <div class="loading-card" role="status" aria-live="polite">
              <div class="spinner" aria-hidden="true"></div>
              <p>Preparing playback...</p>
            </div>
          }

          @if (playbackUrl() && selectedRecording()) {
            <div class="card recordings-player-card">
              <h3 class="playback-title">Now Playing</h3>
              <p class="playback-name">{{ selectedRecording()!.name }}</p>

              @if (isAudioPlayback()) {
                <audio
                  controls
                  [src]="playbackUrl()"
                  class="playback-media"
                  aria-label="Audio playback"
                ></audio>
              } @else {
                <video
                  controls
                  [src]="playbackUrl()"
                  class="playback-media"
                  aria-label="Video playback"
                ></video>
              }
            </div>
          }
        </div>
      }
    </main>
  }

  <footer class="footer">
    <p>Demo application for learning purposes</p>
  </footer>
</div>
